{% extends 'base.html' %}

{% block title %}バンドリハーサル管理 - タイマー{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>🎵 バンドリハーサル管理</h1>
        <p class="text-muted">練習タイマーを管理します</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="/admin/timer_core/timer/add/" class="btn btn-outline-success">タイマー追加</a>
        <a href="/admin/" class="btn btn-outline-secondary">管理画面</a>
    </div>
</div>

{% if timers %}
    <!-- タイマー制御パネル -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">⏰ タイマー制御</h5>
        </div>
        <div class="card-body text-center">
            <div class="timer-duration mb-3" id="current-timer">
                準備完了
            </div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success btn-lg" id="start-btn">
                    <i class="bi bi-play-fill"></i> 開始
                </button>
                <button type="button" class="btn btn-warning btn-lg" id="pause-btn" disabled>
                    <i class="bi bi-pause-fill"></i> 一時停止
                </button>
                <button type="button" class="btn btn-info btn-lg" id="skip-btn" disabled>
                    <i class="bi bi-skip-forward-fill"></i> スキップ
                </button>
                <button type="button" class="btn btn-secondary btn-lg" id="stop-btn" disabled>
                    <i class="bi bi-stop-fill"></i> 停止
                </button>
            </div>
            <div class="mt-3">
                <small class="text-muted">スペースキー: 開始/一時停止 | →キー: スキップ</small>
            </div>
        </div>
    </div>

    <!-- タイマー一覧 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">📋 タイマー一覧 ({{ timers.count }}個)</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>順序</th>
                        <th>バンド名</th>
                        <th>時間</th>
                        <th>管理者</th>
                        <th>状態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for timer in timers %}
                    <tr class="timer-row" data-timer-id="{{ timer.id }}" data-duration="{{ timer.duration_minutes }}">
                        <td>
                            <span class="badge bg-secondary">{{ timer.order }}</span>
                        </td>
                        <td>
                            <strong>{{ timer.band.name }}</strong>
                            {% if timer.name != timer.band.name %}
                                <small class="text-muted d-block">{{ timer.name }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ timer.duration_minutes }}分</span>
                        </td>
                        <td>
                            {% if timer.manager1 %}
                                <span class="badge bg-info manager-badge me-1">{{ timer.manager1 }}</span>
                            {% endif %}
                            {% if timer.manager2 %}
                                <span class="badge bg-info manager-badge me-1">{{ timer.manager2 }}</span>
                            {% endif %}
                            {% if timer.manager3 %}
                                <span class="badge bg-info manager-badge">{{ timer.manager3 }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark status-badge">待機中</span>
                        </td>
                        <td>
                            <a href="/admin/timer_core/timer/{{ timer.id }}/change/" class="btn btn-sm btn-outline-primary">編集</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 進捗表示 -->
    <div class="card mt-4">
        <div class="card-body">
            <h6>進捗状況</h6>
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-bar">
                    0 / {{ timers.count }}
                </div>
            </div>
        </div>
    </div>

{% else %}
    <div class="alert alert-warning">
        <h4>タイマーが登録されていません</h4>
        <p>まずはバンドとタイマーを登録してください。</p>
        <a href="/admin/timer_core/band/add/" class="btn btn-primary me-2">バンドを追加</a>
        <a href="/admin/timer_core/timer/add/" class="btn btn-outline-primary">タイマーを追加</a>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
class ServerTimerManager {
    constructor() {
        this.currentSessionId = null;
        this.statusInterval = null;
        this.websocket = null;
        this.bandId = 1; // デフォルトバンドID（後で動的に設定予定）
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadExistingSession();
        this.initWebSocket();
    }
    
    initWebSocket() {
        // WebSocket接続（Phase 3 準備）
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsPath = `${wsScheme}://${window.location.host}/ws/timer/${this.bandId}/`;
        
        console.log('WebSocket接続試行:', wsPath);
        
        try {
            this.websocket = new WebSocket(wsPath);
            
            this.websocket.onopen = (event) => {
                console.log('WebSocket接続成功');
                this.showConnectionStatus('WebSocket接続済み', 'success');
            };
            
            this.websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocketメッセージ受信:', data);
                this.handleWebSocketMessage(data);
            };
            
            this.websocket.onclose = (event) => {
                console.log('WebSocket切断:', event.code);
                this.showConnectionStatus('WebSocket切断', 'warning');
                // 5秒後に再接続試行
                setTimeout(() => this.initWebSocket(), 5000);
            };
            
            this.websocket.onerror = (error) => {
                console.error('WebSocketエラー:', error);
                this.showConnectionStatus('WebSocket接続エラー', 'error');
            };
            
        } catch (error) {
            console.error('WebSocket初期化エラー:', error);
            this.showConnectionStatus('WebSocket利用不可', 'error');
        }
    }
    
    handleWebSocketMessage(data) {
        switch (data.type) {
            case 'connection_established':
                console.log('接続確立:', data.message);
                break;
                
            case 'timer_update':
                // 将来: リアルタイムタイマー更新
                console.log('タイマー更新:', data.data);
                break;
                
            case 'timer_completed':
                // 将来: タイマー完了通知
                console.log('タイマー完了:', data.data);
                break;
                
            case 'pong':
                console.log('ポング受信');
                break;
                
            default:
                console.log('未知のメッセージタイプ:', data);
        }
    }
    
    showConnectionStatus(message, type) {
        // 接続状態表示（Phase 3で本格実装予定）
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'}`;
        }
    }
    
    sendWebSocketMessage(message) {
        if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
            this.websocket.send(JSON.stringify(message));
        }
    }
    
    bindEvents() {
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const skipBtn = document.getElementById('skip-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        startBtn.addEventListener('click', () => this.startTimer());
        
        // WebSocketテスト用ピングボタン（開発用）
        const pingBtn = document.getElementById('ping-btn');
        if (pingBtn) {
            pingBtn.addEventListener('click', () => {
                this.sendWebSocketMessage({
                    type: 'ping',
                    timestamp: Date.now()
                });
            });
        }
        
        // キーボードショートカット
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                event.preventDefault();
                this.startTimer();
            } else if (event.code === 'ArrowRight') {
                event.preventDefault();
                console.log('スキップ機能は開発中です');
            }
        });
    }
    
    async startTimer() {
        const timerRows = document.querySelectorAll('.timer-row');
        if (timerRows.length === 0) {
            alert('タイマーが登録されていません');
            return;
        }
        
        // 最初のタイマーを使用
        const firstTimer = timerRows[0];
        const timerId = firstTimer.dataset.timerId;
        
        try {
            const response = await fetch('/api/start-timer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken()
                },
                body: JSON.stringify({
                    timer_id: timerId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.currentSessionId = data.session_id;
                this.updateUI('running');
                this.startStatusPolling();
                
                document.getElementById('current-timer').textContent = data.message;
                localStorage.setItem('currentSessionId', this.currentSessionId);
                
                // WebSocketでタイマー開始を通知（Phase 3用準備）
                this.sendWebSocketMessage({
                    type: 'timer_started',
                    session_id: this.currentSessionId,
                    timer_id: timerId
                });
                
            } else {
                alert('エラー: ' + data.message);
            }
            
        } catch (error) {
            console.error('タイマー開始エラー:', error);
            alert('タイマー開始に失敗しました');
        }
    }
    
    async checkTimerStatus() {
        if (!this.currentSessionId) return;
        
        try {
            const response = await fetch(`/api/timer-status/${this.currentSessionId}/`);
            const data = await response.json();
            
            if (data.success && data.status.status !== 'not_found') {
                this.updateTimerDisplay(data.status);
            } else {
                this.stopStatusPolling();
                this.updateUI('stopped');
            }
            
        } catch (error) {
            console.error('ステータス取得エラー:', error);
        }
    }
    
    updateTimerDisplay(status) {
        const currentTimerElement = document.getElementById('current-timer');
        const progressBar = document.getElementById('progress-bar');
        
        if (status.status === 'running') {
            const minutes = Math.floor(status.remaining_seconds / 60);
            const seconds = status.remaining_seconds % 60;
            currentTimerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const progress = ((status.total_seconds - status.remaining_seconds) / status.total_seconds) * 100;
            progressBar.style.width = `${progress}%`;
            
        } else if (status.status === 'completed') {
            currentTimerElement.textContent = 'タイマー完了！';
            progressBar.style.width = '100%';
            this.stopStatusPolling();
            this.updateUI('completed');
            
            alert('タイマーが完了しました！');
        }
    }
    
    startStatusPolling() {
        this.statusInterval = setInterval(() => {
            this.checkTimerStatus();
        }, 1000);
    }
    
    stopStatusPolling() {
        if (this.statusInterval) {
            clearInterval(this.statusInterval);
            this.statusInterval = null;
        }
    }
    
    updateUI(state) {
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const skipBtn = document.getElementById('skip-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        if (state === 'running') {
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            skipBtn.disabled = false;
            stopBtn.disabled = false;
        } else {
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            skipBtn.disabled = true;
            stopBtn.disabled = true;
        }
    }
    
    loadExistingSession() {
        const savedSessionId = localStorage.getItem('currentSessionId');
        if (savedSessionId) {
            this.currentSessionId = savedSessionId;
            this.checkTimerStatus();
            this.startStatusPolling();
        }
    }
    
    getCsrfToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return '';
    }
}

// ページ読み込み完了後に初期化
document.addEventListener('DOMContentLoaded', function() {
    window.timerManager = new ServerTimerManager();
});
</script>
{% endblock %}